<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard - AI Price Alert</title>
  <link rel="stylesheet" href="./static/style.css">
  <style>
    .demo-wrap{max-width:1200px;margin:20px auto;padding:16px}
    .demo-top{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    .demo-card{background:#fff;border-radius:16px;padding:14px;box-shadow:0 12px 30px rgba(0,0,0,.08)}
    .demo-inputs{display:grid;grid-template-columns:2fr 1fr auto;gap:10px;margin:12px 0}
    .demo-inputs input{padding:12px;border:1px solid #ddd;border-radius:10px}
    .btn{border:none;border-radius:10px;padding:12px 16px;font-weight:700;cursor:pointer}
    .btn-primary{background:#ff9800;color:#fff}.btn-light{background:#fff;color:#222;border:1px solid #ddd}
    .stat-grid{display:grid;grid-template-columns:repeat(4,minmax(120px,1fr));gap:10px;margin-top:10px}
    .tracker-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:12px;margin-top:12px}
    .tracker-title{font-size:16px;font-weight:800;line-height:1.3}
    .tracker-url{font-size:12px;word-break:break-all}
    .tracker-row{display:flex;justify-content:space-between;margin-top:8px}
    .pill{display:inline-block;padding:4px 9px;border-radius:999px;font-size:12px;font-weight:700}
    .pill.ok{background:#e7f9ee;color:#15803d}.pill.wait{background:#fff3cd;color:#92400e}
    @media (max-width:768px){.demo-inputs{grid-template-columns:1fr}.stat-grid{grid-template-columns:repeat(2,1fr)}}
  </style>
</head>
<body>
  <div class="scene"><div class="orb orb-1"></div><div class="orb orb-2"></div><div class="orb orb-3"></div></div>
  <div class="demo-wrap">
    <div class="demo-top demo-card">
      <div>
        <h2 style="margin:0">AI Price Alert Dashboard</h2>
        <small id="welcome"></small>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <span id="refreshBadge" class="pill ok">Auto refresh: ON (5s)</span>
        <button class="btn btn-light" id="toggleRefresh">Pause</button>
        <button class="btn btn-light" id="logoutBtn">Logout</button>
      </div>
    </div>

    <div class="demo-card" style="margin-top:12px">
      <div class="demo-inputs">
        <input id="productUrl" placeholder="Paste product URL from Amazon / Flipkart / Myntra / Ajio / Meesho..." />
        <input id="targetPrice" type="number" min="1" step="0.01" placeholder="Target price" />
        <button class="btn btn-primary" id="addTrackerBtn">Start Tracking</button>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn btn-light" id="refreshAllBtn">Refresh All</button>
        <a class="btn btn-light" href="./index.html" style="text-decoration:none">Back to Home</a>
      </div>
    </div>

    <div class="stat-grid" id="stats"></div>
    <div class="tracker-grid" id="trackerGrid"></div>
  </div>

  <script>
    const user = JSON.parse(localStorage.getItem('pa_current_user') || 'null');
    if (!user) window.location.href = './login.html';

    document.getElementById('welcome').textContent = 'Welcome, ' + (user.username || user.email);

    const key = 'pa_trackers_' + user.email;
    let trackers = JSON.parse(localStorage.getItem(key) || '[]');
    let refreshTimer = null;
    let autoOn = true;

    const save = () => localStorage.setItem(key, JSON.stringify(trackers));

    const parseName = (url) => {
      try {
        const u = new URL(url);
        const path = decodeURIComponent(u.pathname.replace(/\/+$/, ''));
        const slug = path.split('/').filter(Boolean).pop() || u.hostname;
        return slug.replace(/[-_]+/g, ' ').replace(/\b\w/g, c => c.toUpperCase()).slice(0, 110);
      } catch { return 'Product'; }
    };

    const renderStats = () => {
      const total = trackers.length;
      const reached = trackers.filter(t => t.current <= t.target).length;
      const active = total - reached;
      const avg = total ? (trackers.reduce((a,t)=>a + ((t.current - t.target) / t.current * 100),0) / total) : 0;
      document.getElementById('stats').innerHTML = [
        ['Total', total], ['Active', active], ['Target Reached', reached], ['Avg Savings', avg > 0 ? avg.toFixed(1) + '%' : '0%']
      ].map(([k,v]) => `<div class="demo-card"><div style="font-size:12px;color:#666">${k}</div><div style="font-size:26px;font-weight:800">${v}</div></div>`).join('');
    };

    const render = () => {
      renderStats();
      const box = document.getElementById('trackerGrid');
      if (!trackers.length) {
        box.innerHTML = '<div class="demo-card">No trackers yet. Add first product link.</div>';
        return;
      }
      box.innerHTML = trackers.map((t, i) => {
        const reached = t.current <= t.target;
        return `<div class="demo-card">
          <div class="tracker-title">${t.name}</div>
          <a class="tracker-url" href="${t.url}" target="_blank" rel="noopener">${t.url}</a>
          <div class="tracker-row"><span>CURRENT</span><strong>₹${t.current.toFixed(2)}</strong></div>
          <div class="tracker-row"><span>TARGET</span><strong>₹${t.target.toFixed(2)}</strong></div>
          <div class="tracker-row"><span class="pill ${reached ? 'ok':'wait'}">${reached ? 'Target Reached' : 'Active'}</span>
            <button class="btn btn-light" onclick="removeTracker(${i})">Delete</button></div>
        </div>`;
      }).join('');
    };

    const randomize = (v) => {
      const drift = (Math.random() - 0.5) * Math.max(3, v * 0.03);
      return Math.max(1, v + drift);
    };

    const refreshAll = () => {
      trackers = trackers.map(t => ({ ...t, current: randomize(t.current) }));
      save();
      render();
    };

    window.removeTracker = (idx) => {
      trackers.splice(idx, 1);
      save();
      render();
    };

    document.getElementById('addTrackerBtn').addEventListener('click', () => {
      const url = document.getElementById('productUrl').value.trim();
      const target = parseFloat(document.getElementById('targetPrice').value);
      if (!url || !/^https?:\/\//i.test(url) || !Number.isFinite(target) || target <= 0) return;
      const base = Math.max(target + 10, target * (1 + (Math.random() * 0.18 + 0.02)));
      trackers.unshift({
        name: parseName(url),
        url,
        target,
        current: base,
        createdAt: Date.now()
      });
      document.getElementById('productUrl').value = '';
      document.getElementById('targetPrice').value = '';
      save();
      render();
    });

    document.getElementById('refreshAllBtn').addEventListener('click', refreshAll);
    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('pa_current_user');
      window.location.href = './index.html';
    });

    const startAuto = () => {
      clearInterval(refreshTimer);
      refreshTimer = setInterval(refreshAll, 5000);
    };

    document.getElementById('toggleRefresh').addEventListener('click', () => {
      autoOn = !autoOn;
      const badge = document.getElementById('refreshBadge');
      const btn = document.getElementById('toggleRefresh');
      if (autoOn) {
        startAuto();
        badge.textContent = 'Auto refresh: ON (5s)';
        btn.textContent = 'Pause';
      } else {
        clearInterval(refreshTimer);
        badge.textContent = 'Auto refresh: OFF';
        btn.textContent = 'Resume';
      }
    });

    render();
    startAuto();
  </script>
</body>
</html>
